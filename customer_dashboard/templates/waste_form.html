<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% if info %}Update{% else %}Create{% endif %} Waste Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
    <style>
        .fc-event-selected {
            background-color: orange !important;
            border-color: orange !important;
        }
    </style>
</head>
<body>

<h1>{% if info %}Update{% else %}Create{% endif %} Waste Profile</h1>
<form method="post">
    {% csrf_token %}

    Full Name: <input type="text" name="full_name" value="{{ info.full_name|default:'' }}" required><br>
    Secondary Number: <input type="text" name="secondary_number" value="{{ info.secondary_number|default:'' }}"><br>
    Pickup Address: <input type="text" name="pickup_address" value="{{ info.pickup_address|default:'' }}" required><br>
    Landmark: <input type="text" name="landmark" value="{{ info.landmark|default:'' }}"><br>
    Pincode: <input type="text" name="pincode" value="{{ info.pincode|default:'' }}" required><br>

    State:
    <select id="state" name="state" required>
        <option value="">-- Select State --</option>
        {% for s in states %}
            <option value="{{ s.id }}" {% if info.state and info.state.id == s.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
    </select><br>

    District:
    <select id="district" name="district" required>
        <option value="">-- Select District --</option>
    </select><br>

    Local Body:
    <select id="localbody" name="localbody" required>
        <option value="">-- Select Local Body --</option>
    </select><br>

    <!-- Hidden input for LocalBodyCalendar ID -->
    <input type="hidden" name="selected_date" id="selected_date" value="">

    <div id="calendar" style="max-width:900px;margin-top:20px;"></div><br>

    Ward:
    <select name="ward" required>
        <option value="">-- Select Ward --</option>
        {% for i in ward_range %}
            <option value="{{ i }}" {% if info and info.ward|stringformat:'s' == i|stringformat:'s' %}selected{% endif %}>Ward {{ i }}</option>
        {% endfor %}
    </select><br>

    Number of Bags:
    <select name="number_of_bags" required>
        <option value="">-- Select --</option>
        {% for i in bag_range %}
            <option value="{{ i }}" {% if info and info.number_of_bags == i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
    </select><br>

    Waste Type:
    <select name="waste_type" required>
        <option value="">-- Select --</option>
        <option value="Organic Waste" {% if info and info.waste_type == "Organic Waste" %}selected{% endif %}>Organic Waste</option>
        <option value="Recyclable Waste" {% if info and info.waste_type == "Recyclable Waste" %}selected{% endif %}>Recyclable Waste</option>
        <option value="Mixed Waste" {% if info and info.waste_type == "Mixed Waste" %}selected{% endif %}>Mixed Waste</option>
        <option value="Electronic Waste" {% if info and info.waste_type == "Electronic Waste" %}selected{% endif %}>Electronic Waste</option>
    </select><br>

    <button type="submit">{% if info %}Update{% else %}Create{% endif %}</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
$(document).ready(function(){

    let selectedDistrict = "{{ info.district.id|default:'' }}";
    let selectedLocalbody = "{{ info.localbody.id|default:'' }}";
    let selectedDateId = "{% if selected_dates %}{{ selected_dates.0.localbody_calendar.id }}{% else %}{% endif %}";

    // Init calendar
    var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        selectable: false,
        editable: false,
        events: [],
        eventClick: function(info) {
            if (info.event.title === "Available") {
                calendar.getEvents().forEach(function(e){ e.setProp('classNames', []); });
                info.event.setProp('classNames', ['fc-event-selected']);
                $("#selected_date").val(info.event.id);
            }
        },
        eventDidMount: function(info) {
            if (info.event.title === "Available") {
                info.el.style.backgroundColor = "green";
                info.el.style.cursor = "pointer";
            } else {
                info.el.style.backgroundColor = "lightgray";
                info.el.style.cursor = "not-allowed";
            }
            if (info.event.id == selectedDateId) {
                info.event.setProp('classNames', ['fc-event-selected']);
                $("#selected_date").val(selectedDateId);
            }
        }
    });
    calendar.render();

    function loadDistricts(stateId, callback){
        $.get("/customer-dashboard/load_districts/" + stateId + "/", function(data){
            $("#district").empty().append('<option value="">-- Select District --</option>');
            data.forEach(function(d){
                let sel = (d.id == selectedDistrict) ? "selected" : "";
                $("#district").append('<option value="'+d.id+'" '+sel+'>'+d.name+'</option>');
            });
            if(callback) callback();
        });
    }

    function loadLocalBodies(districtId, callback){
        $.get("/customer-dashboard/load_localbodies/" + districtId + "/", function(data){
            $("#localbody").empty().append('<option value="">-- Select Local Body --</option>');
            data.forEach(function(lb){
                let sel = (lb.id == selectedLocalbody) ? "selected" : "";
                $("#localbody").append('<option value="'+lb.id+'" '+sel+'>'+lb.name+' ('+lb.body_type+')</option>');
            });
            if(callback) callback();
        });
    }

    function loadCalendar(localbodyId){
        calendar.removeAllEvents();
        $("#selected_date").val('');
        $.get("/customer-dashboard/available_dates/" + localbodyId + "/", function(events){
            events.forEach(function(e){
                calendar.addEvent({
                    id: e.id,
                    title: e.picked ? "Picked" : "Available",
                    start: e.date,
                    color: e.picked ? "blue" : "green",
                    extendedProps: { picked: e.picked }
                });
            });
        });
    }

    $("#state").change(function(){
        let stateId = $(this).val();
        if(stateId){ loadDistricts(stateId); }
    });
    $("#district").change(function(){
        let districtId = $(this).val();
        if(districtId){ loadLocalBodies(districtId); }
    });
    $("#localbody").change(function(){
        let lbId = $(this).val();
        if(lbId){ loadCalendar(lbId); }
    });

    // Auto-load for update
    if($("#state").val()){
        loadDistricts($("#state").val(), function(){
            if(selectedDistrict){
                loadLocalBodies(selectedDistrict, function(){
                    if(selectedLocalbody){
                        loadCalendar(selectedLocalbody);
                    }
                });
            }
        });
    }

});
</script>
</body>
</html>
